{"version":3,"sources":["../src/echarts_ctrl.js"],"names":["MetricsPanelCtrl","_","kbn","echarts","EchartsCtrl","$scope","$injector","panelDefaults","EchartsOption","IS_MAP","map","USE_URL","USE_FAKE_DATA","fakeData","url","method","request","updateInterval","methods","maps","defaults","panel","events","on","onDataReceived","bind","onDataError","onInitEditMode","that","xmlhttp","window","XMLHttpRequest","ActiveXObject","onreadystatechange","readyState","status","UrlData","JSON","parse","responseText","open","send","dataList","updateData","data","eval","IS_DATA_CHANGED","render","err","addEditorTab","unitFormats","getUnitFormats","System","import","getPanelPath","grafanaBootData","settings","panels","pluginId","baseUrl","scope","elem","attrs","ctrl","$panelContainer","find","option","echartsData","setHeight","height","row","isString","parseInt","replace","style","myChart","init","importMap","setTimeout","resize","callInterval","timeout","result","func","callBack","interval","context","args","arguments","clearInterval","setInterval","apply","clear","setOption","renderingCompleted","templateUrl"],"mappings":"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","file":"echarts_ctrl.js","sourcesContent":["import { MetricsPanelCtrl } from 'app/plugins/sdk';\nimport _ from 'lodash';\nimport kbn from 'app/core/utils/kbn';\nimport echarts from './libs/echarts.min';\nimport './libs/echarts-liquidfill.min';\nimport './libs/echarts-wordcloud.min';\nimport './libs/dark';\nimport './style.css!';\nimport './libs/bmap.js';\nimport './libs/getBmap.js';\n\nexport class EchartsCtrl extends MetricsPanelCtrl {\n\n    constructor($scope, $injector) {\n        super($scope, $injector);\n\n        const panelDefaults = {\n            EchartsOption: 'console.log(JSON.stringify(echartsData));\\n\\n option = {};',\n            IS_MAP: false,\n            map: '',\n            USE_URL: false,\n            USE_FAKE_DATA: true,\n            fakeData: '',\n            url: '',\n            method: 'POST',\n            request: '',\n            updateInterval: 10000\n        };\n\n        this.methods = ['GET', 'POST'];\n        this.maps = ['世界', '中国', '北京'];\n\n        _.defaults(this.panel, panelDefaults);\n\n        this.events.on('data-received', this.onDataReceived.bind(this));\n        this.events.on('data-error', this.onDataError.bind(this));\n        this.events.on('data-snapshot-load', this.onDataReceived.bind(this));\n        this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\n\n    }\n\n    //post请求\n    updateData() {\n        let that = this, xmlhttp;\n\n        if (window.XMLHttpRequest) {\n            xmlhttp = new XMLHttpRequest();\n        } else {\n            xmlhttp = new ActiveXObject(\"Microsoft.XMLHTTP\");\n        }\n\n        xmlhttp.onreadystatechange = function () {\n            if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {\n                that.UrlData = JSON.parse(xmlhttp.responseText);\n            }\n        };\n\n        if (that.panel.USE_URL && !that.panel.USE_FAKE_DATA && that.panel.url) {\n            xmlhttp.open(this.panel.method, that.panel.url, true);\n            if (that.panel.request) {\n                xmlhttp.send(that.panel.request);\n            } else {\n                xmlhttp.send();\n            }\n        } else {\n            xmlhttp = null;\n        }\n    }\n\n    onDataReceived(dataList) {\n        this.updateData();\n        \n        this.data = this.panel.USE_URL ? this.UrlData : dataList;\n\n        if (this.panel.USE_URL && this.panel.USE_FAKE_DATA && this.panel.fakeData) {\n            this.data = eval(this.panel.fakeData); // jshint ignore:line\n        }\n\n        this.IS_DATA_CHANGED = true;\n        this.render();\n        this.IS_DATA_CHANGED = false;\n    }\n\n    onDataError(err) {\n        this.render();\n    }\n\n    onInitEditMode() {\n        this.addEditorTab('数据', 'public/plugins/dxc-echarts-panel/editer-metric.html', 2);\n        this.addEditorTab('Options', 'public/plugins/dxc-echarts-panel/editor-echarts.html', 3);\n        this.unitFormats = kbn.getUnitFormats();\n    }\n\n    importMap() {\n        if (!this.panel.IS_MAP) return;\n        switch (this.panel.map) {\n            case '世界':\n                System.import(this.getPanelPath() + 'libs/world.js');\n                break;\n            case '中国':\n                System.import(this.getPanelPath() + 'libs/china.js');\n                break;\n            case '北京':\n                System.import(this.getPanelPath() + 'libs/beijing.js');\n                break;\n            // case '百度地图':\n            //     System.import(this.getPanelPath() + 'libs/bmap.js');\n            //     System.import(this.getPanelPath() + 'libs/getBmap.js');\n            // break;\n            default:\n                break;\n        }\n    }\n\n    getPanelPath() {\n        // the system loader preprends publib to the url, add a .. to go back one level\n        return '../' + grafanaBootData.settings.panels[this.pluginId].baseUrl + '/';\n    }\n\n    link(scope, elem, attrs, ctrl) {\n        const $panelContainer = elem.find('.echarts_container')[0];\n        let option = {},\n            echartsData = [];\n\n        ctrl.IS_DATA_CHANGED = true;\n\n        function setHeight() {\n            let height = ctrl.height || panel.height || ctrl.row.height;\n            if (_.isString(height)) {\n                height = parseInt(height.replace('px', ''), 10);\n            }\n            // height -= 7;\n            // height -= ctrl.panel.title ? 25 : 9;\n            $panelContainer.style.height = height + 'px';\n        }\n\n        // function setWidth() {\n        //     let width = document.body.clientWidth;\n        //     width = (width - 5.6 * 2) * ctrl.panel.span / 12 - 5.6 * 2 - 1 * 2 - 10 * 2;\n        //     $panelContainer.style.width = width + 'px';\n        // }\n\n        setHeight();\n        // setWidth();\n\n        let myChart = echarts.init($panelContainer, 'dark');\n\n        ctrl.importMap();\n\n        // bad hank\n        setTimeout(function () {\n            myChart.resize();\n        }, 1000);\n\n        // 防止重复触发事件\n        var callInterval = function callInterval() {\n            var timeout, result;\n\n            function func(callBack, interval) {\n                var context = this; // jshint ignore:line\n                var args = arguments;\n\n                if (timeout) clearInterval(timeout);\n\n                timeout = setInterval(function () {\n                    result = callBack.apply(context, args);\n                }, interval);\n\n                return result;\n            }\n\n            return func;\n        }();\n\n        function render() {\n\n            if (!myChart) {\n                return;\n            }\n\n            setHeight();\n            myChart.resize();\n\n            if (ctrl.IS_DATA_CHANGED) {\n                myChart.clear();\n                echartsData = ctrl.data;\n\n                eval(ctrl.panel.EchartsOption); // jshint ignore:line\n\n                myChart.setOption(option);\n            }\n        }\n\n        this.events.on('render', function () {\n            render();\n            ctrl.renderingCompleted();\n        });\n    }\n}\n\nEchartsCtrl.templateUrl = 'module.html';\n"]}